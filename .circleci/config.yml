# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1
executors:
  my-executor:
    machine:
      enabled: true
      image: ubuntu-1604:201903-01
    working_directory: ~/repo
    environment:
      shell: /bin/bash
      TERM: xterm
commands:
  setup-build-environment:
    description: "Setup build Environment"
    steps:
      - run:
          shell: /bin/bash
          name: Setup build environment
          command: |
            cd platform-setup
            sudo ./setup-ubuntu16.04.sh
  setup-branch:
    description: "Setup branch"
    steps:
      - run:
          shell: /bin/bash
          name: Setup branch
          command: |
            if [ "$CIRCLE_BRANCH" = "develop" ]; then
              git branch --set-upstream-to=origin/develop develop
              make update
            fi
  build-branch:
    description: "Build branch"
    steps:
      - run:
          shell: /bin/bash
          name: Build branch
          command: |
            yes| make build
  e2e-test:
    description: "E2E test"
    steps:
      - run:
          shell: /bin/bash
          name: E2e Test
          command: |
            yes| make test          
jobs:
  build:
    executor: my-executor
    steps:
      - checkout
      - setup-build-environment
      - setup-branch
      - build-branch
      - e2e-test
      
  pushImages:
    executor: my-executor
    steps:       
      - run:
          shell: /bin/bash
          name: E2e Test
          command: |
            docker login  -u ${DOCKER_USERNAME} -p {DOCKER_PASSWORD}
            
workflows:
  version: 2.1
  workflow:
    jobs:
      - build
      - pushImages:
          requires:
            - build